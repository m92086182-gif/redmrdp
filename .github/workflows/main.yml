name: Windows RDP Server (Fixed)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Ù…Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø³Ø§Ø¹Ø§Øª)'
        required: true
        default: '72'
        type: choice
        options:
          - '24'
          - '48'
          - '72'
          - '168'

jobs:
  deploy-rdp:
    runs-on: windows-latest
    timeout-minutes: 4320

    steps:
    - name: Ø¥Ø¹Ø¯Ø§Ø¯ RDP Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
      run: |
        Write-Host "ğŸ”§ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ RDP..."
        
        # 1. ØªÙØ¹ÙŠÙ„ RDP
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
        Write-Host "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ RDP"
        
        # 2. ØªØ¹Ø·ÙŠÙ„ NLA
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -Force
        Write-Host "âœ… ØªÙ… ØªØ¹Ø·ÙŠÙ„ NLA"

    - name: ÙØªØ­ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ
      run: |
        # ÙØªØ­ Ù…Ù†ÙØ° RDP
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        Write-Host "âœ… ØªÙ… ÙØªØ­ Ù…Ù†ÙØ° 3389"

    - name: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…
      run: |
        $password = "P@ssw0rd123"
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
        New-LocalUser -Name "RDPUser" -Password $securePassword -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
        
        echo "RDP_USER=RDPUser" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV
        Write-Host "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"

    - name: ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
      run: |
        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø§Øª RDP
        Restart-Service -Name "TermService" -Force
        Start-Sleep -Seconds 10
        Write-Host "âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª"

    - name: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
      run: |
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP Ø§Ù„Ø¹Ø§Ù…
        $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org").Trim()
        echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP Ø§Ù„Ù…Ø­Ù„ÙŠ
        $localIP = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -eq "Ethernet" -or $_.InterfaceAlias -eq "Wi-Fi"}).IPAddress
        echo "LOCAL_IP=$localIP" >> $env:GITHUB_ENV
        
        Write-Host "âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©"

    - name: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ RDP
      run: |
        Write-Host "ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ RDP..."
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø¯Ù…Ø©
        $service = Get-Service -Name "TermService"
        Write-Host "ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø¯Ù…Ø©: $($service.Status)"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙØªØ­ Ø§Ù„Ù…Ù†ÙØ°
        $portTest = Test-NetConnection -ComputerName localhost -Port 3389 -InformationLevel Quiet
        Write-Host "ğŸ”Œ ÙØªØ­ Ø§Ù„Ù…Ù†ÙØ°: $portTest"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±ÙŠØ¬Ø³ØªØ±ÙŠ
        $rdpEnabled = Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections"
        Write-Host "âš™ï¸  RDP Ù…ÙØ¹Ù„: $($rdpEnabled.fDenyTSConnections -eq 0)"

    - name: Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
      run: |
        Write-Host ""
        Write-Host "=" * 70
        Write-Host "ğŸ¯ RDP SERVER READY - Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¬Ø§Ù‡Ø²"
        Write-Host "=" * 70
        Write-Host "ğŸŒ PUBLIC IP: $env:PUBLIC_IP"
        Write-Host "ğŸ  LOCAL IP: $env:LOCAL_IP" 
        Write-Host "ğŸ‘¤ USERNAME: $env:RDP_USER"
        Write-Host "ğŸ”‘ PASSWORD: $env:RDP_PASS"
        Write-Host "ğŸšª PORT: 3389"
        Write-Host "â° DURATION: ${{ github.event.inputs.duration }} hours"
        Write-Host "=" * 70
        Write-Host "ğŸ“ Ù„Ù„Ø§ØªØµØ§Ù„: mstsc â†’ $env:PUBLIC_IP"
        Write-Host "=" * 70
        Write-Host ""

    - name: Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†Ø´Ø·
      run: |
        $duration = ${{ github.event.inputs.duration }}
        $endTime = (Get-Date).AddHours($duration)
        
        while ((Get-Date) -lt $endTime) {
            $timeLeft = $endTime - (Get-Date)
            $hoursLeft = [math]::Round($timeLeft.TotalHours, 1)
            
            Write-Host "[$(Get-Date)] ğŸŸ¢ RDP Active - $hoursLeft hours remaining"
            Write-Host "   IP: $env:PUBLIC_IP | User: $env:RDP_USER | Pass: $env:RDP_PASS"
            
            # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
            try {
                $test = Test-NetConnection -ComputerName localhost -Port 3389 -WarningAction SilentlyContinue
                if (-not $test.TcpTestSucceeded) {
                    Write-Host "   ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©..."
                    Restart-Service -Name "TermService" -Force
                }
            } catch {
                Write-Host "   âš ï¸  Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"
            }
            
            Start-Sleep -Seconds 60
        }
