name: Windows RDP Server (Public)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ูุฏุฉ ุงูุชุดุบูู (ุณุงุนุงุช)'
        required: true
        default: '72'
        type: choice
        options:
          - '24'
          - '48'
          - '72'
          - '168'

env:
  CUSTOM_PORT: 3389
  USERNAME: 'AdminRDP'

jobs:
  deploy-public-rdp:
    runs-on: windows-latest
    timeout-minutes: 4320

    steps:
    - name: ุงูุชุญูู ูู ุงูููุงุตูุงุช
      run: |
        echo "๐ฅ๏ธ ููุงุตูุงุช ุงูุณูุฑูุฑ:"
        systeminfo | findstr /C:"Total Physical Memory"
        systeminfo | findstr /C:"Processor(s)"

    - name: ุชุนุทูู ุฅุนุฏุงุฏุงุช ุงูุฃูุงู ุงููุคูุชุฉ ูููRDP
      run: |
        # ุชูุนูู RDP
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
        
        # ุชุนุทูู NLA ูุคูุชุงู ููุงุชุตุงู ุงูุณูู
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -Force
        
        # ุฅุนุฏุงุฏุงุช ุงูุฌูุณุงุช ุงููุชุนุฏุฏุฉ
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fSingleSessionPerUser" -Value 0 -Force

    - name: ูุชุญ ููุงูุฐ RDP ูู ุงูุฌุฏุงุฑ ุงููุงุฑู
      run: |
        # ุญุฐู ุฃู ููุงุนุฏ ููุฌูุฏุฉ ูุณุจูุงู
        netsh advfirewall firewall delete rule name="PublicRDP" 2>&1 | Out-Null
        
        # ูุชุญ ูููุฐ RDP ุงูุงูุชุฑุงุถู
        netsh advfirewall firewall add rule name="PublicRDP" dir=in action=allow protocol=TCP localport=$env:CUSTOM_PORT
        
        # ุฅุธูุงุฑ ุงูููุงุนุฏ ุงููุถุงููุฉ
        netsh advfirewall firewall show rule name="PublicRDP"

    - name: ุฅูุดุงุก ูุณุชุฎุฏู ูุณุคูู
      run: |
        # ุงุณุชุฎุฏุงู ูููุฉ ูุฑูุฑ ุซุงุจุชุฉ
        $password = "qwertyuiop"
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        
        # ุญุฐู ุงููุณุชุฎุฏู ุฅุฐุง ูุงู ููุฌูุฏุงู ูุณุจูุงู
        try {
            Remove-LocalUser -Name $env:USERNAME -ErrorAction SilentlyContinue
        } catch { }
        
        # ุฅูุดุงุก ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ
        New-LocalUser -Name $env:USERNAME -Password $securePassword -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member $env:USERNAME
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:USERNAME
        
        # ุชูุนูู ุญุณุงุจ Administrator ุงููุฏูุฌ
        Enable-LocalUser -Name "Administrator"
        Set-LocalUser -Name "Administrator" -Password $securePassword
        
        # ุญูุธ ุจูุงูุงุช ุงูุฏุฎูู
        echo "RDP_USERNAME=$env:USERNAME" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "RDP_PASSWORD=$password" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "ADMIN_PASSWORD=$password" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: ุงูุญุตูู ุนูู IP ุงูุนุงู
      run: |
        # ุงูุญุตูู ุนูู IP ุงูุนุงู
        try {
            $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 10).Trim()
            echo "PUBLIC_IP=$publicIP" | Out-File -FilePath $env:GITHUB_ENV -Append
        } catch {
            echo "PUBLIC_IP=Unable to get public IP" | Out-File -FilePath $env:GITHUB_ENV -Append
        }
        
        # ุชุนููู ุงุณู ุฌูุงุฒ
        $hostname = "GH-RDP-$env:GITHUB_RUN_ID"
        Rename-Computer -NewName $hostname -Force
        echo "COMPUTER_NAME=$hostname" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: ุชุญุณูู ุฃุฏุงุก Windows
      run: |
        # ุชุญุณูู ุฅุนุฏุงุฏุงุช ุงูุฃุฏุงุก
        powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        # ุชุนุทูู ุงูุณููู
        powercfg -change -standby-timeout-ac 0
        powercfg -change -hibernate-timeout-ac 0

    - name: ุชุดุบูู ุฎุฏูุงุช RDP
      run: |
        # ุฅุนุงุฏุฉ ุชุดุบูู ุฎุฏูุงุช RDP
        Restart-Service -Name "TermService" -Force
        Start-Sleep -Seconds 5

    - name: ุนุฑุถ ูุนูููุงุช ุงูุงุชุตุงู
      run: |
        Write-Host ""
        Write-Host "=" * 60
        Write-Host "๐ฏ RDP ุงูุณูุฑูุฑ ุฌุงูุฒ ููุงุณุชุฎุฏุงู!"
        Write-Host "=" * 60
        Write-Host "๐ IP ุงูุนุงู: $env:PUBLIC_IP"
        Write-Host "๐ช ุงููููุฐ: $env:CUSTOM_PORT"
        Write-Host "๐ค ุงููุณุชุฎุฏู: $env:RDP_USERNAME"
        Write-Host "๐ ูููุฉ ุงููุฑูุฑ: $env:RDP_PASSWORD"
        Write-Host "๐ ุงููุณุคูู: Administrator"
        Write-Host "๐ ูููุฉ ูุฑูุฑ ุงููุณุคูู: $env:ADMIN_PASSWORD"
        Write-Host "๐ป ุงุณู ุงูุฌูุงุฒ: $env:COMPUTER_NAME"
        Write-Host "โฐ ุงููุฏุฉ: ${{ github.event.inputs.duration }} ุณุงุนุฉ"
        Write-Host "=" * 60
        Write-Host "๐ ููุงุชุตุงู: mstsc โ $env:PUBLIC_IP:$env:CUSTOM_PORT"
        Write-Host "=" * 60
        Write-Host ""

    - name: ุงููุฑุงูุจุฉ ุงููุณุชูุฑุฉ
      run: |
        $duration = ${{ github.event.inputs.duration }}
        $endTime = (Get-Date).AddHours($duration)
        $checkInterval = 300
        
        while ((Get-Date) -lt $endTime) {
            $timeLeft = $endTime - (Get-Date)
            $hoursLeft = [math]::Round($timeLeft.TotalHours, 1)
            
            Write-Host "[$(Get-Date)] โ ุงูุณูุฑูุฑ ูุนูู - $hoursLeft ุณุงุนุฉ ูุชุจููุฉ"
            Write-Host "๐ IP: $env:PUBLIC_IP - ๐ค User: $env:RDP_USERNAME - ๐ Pass: $env:RDP_PASSWORD"
            
            # ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุงููุญูู
            try {
                $test = Test-NetConnection -ComputerName localhost -Port $env:CUSTOM_PORT -WarningAction SilentlyContinue
                if (-not $test.TcpTestSucceeded) {
                    Write-Host "ุฅุนุงุฏุฉ ุชูุนูู RDP..."
                    Restart-Service -Name "TermService" -Force
                    Start-Sleep -Seconds 10
                }
            } catch {
                Write-Host "ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุฉ..."
                Restart-Service -Name "TermService" -Force
                Start-Sleep -Seconds 10
            }
            
            Start-Sleep -Seconds $checkInterval
        }
        
        Write-Host "โฐ ุงูุชูุช ุงููุฏุฉ - ุฅููุงู ุงูุณูุฑูุฑ"

    - name: ุงูุชูุธูู ุงูููุงุฆู
      if: always()
      run: |
        Write-Host "๐งน ุฌุงุฑู ุงูุชูุธูู..."
        # ุชุนุทูู RDP
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 1 -Force
        
        # ุญุฐู ููุงุนุฏ ุงูุฌุฏุงุฑ ุงููุงุฑู
        netsh advfirewall firewall delete rule name="PublicRDP" 2>&1 | Out-Null
        
        # ุญุฐู ุงููุณุชุฎุฏููู
        try {
            Remove-LocalUser -Name $env:USERNAME -ErrorAction SilentlyContinue
        } catch { }
        
        Write-Host "โ ุชู ุงูุชูุธูู ุจูุฌุงุญ"
